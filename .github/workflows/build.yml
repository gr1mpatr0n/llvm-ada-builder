name: Build GNAT LLVM for AArch64 Windows MinGW Cross-Compile

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout GNAT LLVM
      uses: actions/checkout@v4
      with:
        repository: AdaCore/gnat-llvm
        path: gnat-llvm

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git make cmake gnat-11 g++-11 python3 zlib1g-dev libmpfr-dev libgmp-dev libmpc-dev

    - name: Clone GCC Ada sources
      run: |
        cd gnat-llvm
        git clone git://gcc.gnu.org/git/gcc.git llvm-interface/gcc
        ln -s gcc/gcc/ada llvm-interface/gnat_src

    - name: Clone LLVM Ada bindings
      run: |
        cd gnat-llvm
        git clone https://github.com/AdaCore/llvm-bindings.git

    - name: Build LLVM from source
      run: |
        cd gnat-llvm
        make llvm

    - name: Build GNAT LLVM
      run: |
        cd gnat-llvm
        make

    - name: Test targeting AArch64 Windows MinGW
      run: |
        cd gnat-llvm
        export PATH=$PWD/llvm-interface/bin:$PATH
        echo 'procedure Main is begin null; end Main;' > main.adb
        llvm-gcc -c -emit-llvm -target aarch64-w64-mingw32 main.adb -o main.bc
        test -f main.bc && test -s main.bc && echo "Target test passed"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gnat-llvm-build
        path: |
          gnat-llvm/llvm-interface/bin/*
          gnat-llvm/llvm-interface/lib/*
        retention-days: 7
